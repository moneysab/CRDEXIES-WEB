<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="mb-0">{{ 'VISA_TRANSACTIONS.VISA_TRANSACTIONS_REPORT' | translate }}</h2>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary" (click)="exportTocsv()">
          <i class="bi bi-file-earmark-excel"></i> {{ 'BUTTONS.EXPORT' | translate }}
        </button>
      </div>
    </div>
  
    <div class="card-body">
      <div>
      <form [formGroup]="transactionsForm" (ngSubmit)="applyFilters()" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label for="startDate" class="form-label">{{ 'FILTERS.START_DATE' | translate }}</label>
          <input type="date" class="form-control" id="startDate" formControlName="startDate"  />
        </div>
        <div class="col-md-3">
          <label for="endDate" class="form-label">{{ 'FILTERS.END_DATE' | translate }}</label>
          <input type="date" class="form-control" id="endDate" formControlName="endDate"  />
        </div>
        
        <div class="col-md-3">
          <label for="currencyCode" class="form-label">{{ 'FILTERS.SETTLEMENT_CURRENCY' | translate }}</label>
          <select class="form-select" formControlName="currencyCode">
            <option value=""> </option>
            <option *ngFor="let currency of availableFilters?.settlementCurrencyCodes" 
                    [value]="currency.code">
              {{ currency.label }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
            <label for="clearingCurrencyCode" class="form-label">{{ 'FILTERS.CLEARING_CURRENCY' | translate }}</label>
            <select class="form-select" formControlName="clearingCurrencyCode">
              <option value=""> </option>
              <option *ngFor="let currency of availableFilters?.clearingCurrencyCodes" 
                      [value]="currency.code">
                {{ currency.label }}
              </option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="transactionType" class="form-label">{{ 'FILTERS.TRANSACTIONS_TYPE' | translate }}</label>
            <select class="form-select" formControlName="transactionType">
              <option value=""> </option>
              <option *ngFor="let transactionType of availableFilters?.transactionTypes" 
                      [value]="transactionType.code">
                {{ transactionType.label }}
              </option>
            </select>
        </div>
        
        <div class="col-md-3">
          <label for="binCode" class="form-label">{{ 'FILTERS.BIN' | translate }}</label>
          <select class="form-select" formControlName="binCode">
            <option value=""> </option>
            <option *ngFor="let bin of availableFilters?.destinationIds" 
                    [value]="bin">
              {{ bin }}
            </option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label for="businessModeCode" class="form-label">{{ 'FILTERS.BUSINESS_MODE' | translate }}</label>
          <select class="form-select" formControlName="businessModeCode">
            <option value=""> </option>
            <option *ngFor="let mode of availableFilters?.businessModes" 
                    [value]="mode.code">
              {{ mode.label }}
            </option>
          </select>
        </div>
        
        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search me-1"></i> {{ 'BUTTONS.SEARCH' | translate }}
          </button>
        </div>
  
        <div class="col-md-2 d-grid">
          <button type="button" class="btn btn-secondary" (click)="resetFilters()">
            <i class="bi bi-arrow-counterclockwise me-1"></i> {{ 'BUTTONS.RESET' | translate }}
          </button>
        </div>
      </form>
    </div>

      <!-- Toggle button -->
<div class="text-end mt-2 mb-3">
    <button class="btn btn-primary" (click)="toggleView()">
      <i class="bi" [ngClass]="isGraphView ? 'bi-table' : 'bi-bar-chart'"></i>
      {{ isGraphView ? ('BUTTONS.TABLE_VIEW' | translate) : ('BUTTONS.CHART_VIEW' | translate) }}
    </button>
  </div>

  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="ms-2">{{'LOADING.LOADING'|translate}}</span>
  </div>
  
  <div *ngIf="error" class="alert alert-danger mt-3">{{ error }}</div>


  <div *ngIf="transactionsData?.settlementCurrencies?.length && isGraphView">
    <!-- Currency Charts -->
    <div class="card mb-4" *ngIf="currencyChartSeries.length > 0">
      <div class="card-header">
        <h4 class="mb-0">{{ 'VISA_TRANSACTIONS.SUMMARY_BY_CURRENCY' | translate }}</h4>
      </div>
      <div class="card-body row">
        <!-- Totals -->
        <div class="col-md-6">
          <apx-chart
            [series]="currencyChartSeries"
            [chart]="currencyChartOptions?.chart"
            [xaxis]="currencyChartOptions?.xaxis"
            [plotOptions]="currencyChartOptions?.plotOptions"
            [colors]="currencyChartOptions?.colors"
            [title]="currencyChartOptions?.title"
            [dataLabels]="currencyChartOptions.dataLabels">
          </apx-chart>
        </div>
        <!-- Averages -->
        <div class="col-md-6">
          <apx-chart
            [series]="averageStackedSeries"
            [chart]="averageStackedOptions?.chart"
            [xaxis]="averageStackedOptions?.xaxis"
            [plotOptions]="averageStackedOptions?.plotOptions"
            [colors]="averageStackedOptions?.colors"
            [tooltip]="averageStackedOptions?.tooltip"
            [legend]="averageStackedOptions?.legend"
            [title]="averageStackedOptions?.title"
            [dataLabels]="averageStackedOptions.dataLabels">
          </apx-chart>
        </div>
      </div>
    </div>
  
    <!-- BIN Charts -->
    <div class="card mb-4" *ngIf="binBarSeries.length > 0">
      <div class="card-header" >
        <h4 class="mb-0">{{ 'VISA_TRANSACTIONS.TRANSACTIONS_BY_BIN' | translate }}</h4>
      </div>
      <div class="card-body row">
        <div class="col-md-6">
          <apx-chart
            [series]="binBarSeries"
            [chart]="binBarOptions?.chart"
            [xaxis]="binBarOptions?.xaxis"
            [plotOptions]="binBarOptions?.plotOptions"
            [colors]="binBarOptions?.colors"
            [title]="binBarOptions?.title"
            [dataLabels]="binBarOptions.dataLabels">
          </apx-chart>
        </div>
        <div class="col-md-6">
          <apx-chart
            [series]="binAvgSeries"
            [chart]="binAvgOptions?.chart"
            [xaxis]="binAvgOptions?.xaxis"
            [plotOptions]="binAvgOptions?.plotOptions"
            [tooltip]="binAvgOptions?.tooltip"
            [colors]="binAvgOptions?.colors"
            [title]="binAvgOptions?.title"
            [dataLabels]="binAvgOptions.dataLabels">
          </apx-chart>
        </div>
      </div>
    </div>
  
    <!-- Business Mode Charts -->
    <div class="card mb-4" *ngIf="businessModeSeries.length > 0">
      <div class="card-header" >
        <h4 class="mb-0">{{ 'VISA_TRANSACTIONS.TRANSACTIONS_BY_BUSINESS_MODE' | translate }}</h4>
      </div>
      <div class="card-body row">
        <div class="col-md-6">
          <apx-chart
            [series]="businessModeSeries"
            [chart]="businessModeOptions?.chart"
            [xaxis]="businessModeOptions?.xaxis"
            [plotOptions]="businessModeOptions?.plotOptions"
            [title]="businessModeOptions?.title"
            [dataLabels]="businessModeOptions.dataLabels">
          </apx-chart>
        </div>
        <div class="col-md-6">
          <apx-chart
            [series]="businessModeAvgSeries"
            [chart]="businessModeAvgOptions?.chart"
            [xaxis]="businessModeAvgOptions?.xaxis"
            [plotOptions]="businessModeAvgOptions?.plotOptions"
            [tooltip]="businessModeAvgOptions?.tooltip"
            [colors]="businessModeAvgOptions?.colors"
            [title]="businessModeAvgOptions?.title"
            [dataLabels]="businessModeAvgOptions.dataLabels">
          </apx-chart>
        </div>
      </div>
    </div>
  </div>
 
  
     
      <div *ngIf="transactionsData?.settlementCurrencies?.length && !isGraphView" class="mt-4">
        <div class="currency-summary-header  text-white p-3 rounded-top">
          <h4 class="mb-0">{{ 'VISA_TRANSACTIONS.SUMMARY_BY_CURRENCY' | translate }}</h4>
        </div>
        <div class="table-responsive border">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Currency</th>
                <th>Total Transactions</th>
                <th>Credit Transactions</th>
                <th>Debit Transactions</th>
                <th>Total Credit</th>
                <th>Total Debit</th>
                <th>Avg Credit</th>
                <th>Avg Debit</th>
                <th>Net Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let currency of transactionsData.settlementCurrencies">
                <td class="fw-bold text-primary">{{ currency.settlementCurrency }}</td>
                <td>{{ formatNumber(currency.totalTransactionCount) }}</td>
                <td>{{ formatNumber(currency.totalCreditTransactionCount) }}</td>
                <td>{{ formatNumber(currency.totalDebitTransactionCount) }}</td>
                <td class="text-success">{{ formatCurrency(currency.totalCreditAmount, currency.settlementCurrency) }}</td>
                <td class="text-warning">{{ formatCurrency(currency.totalDebitAmount, currency.settlementCurrency) }}</td>
                <td class="text-success">{{ formatCurrency(currency.averageCreditAmount, currency.settlementCurrency) }}</td>
                <td class="text-warning">{{ formatCurrency(currency.averageDebitAmount, currency.settlementCurrency) }}</td>
                <td [ngClass]="{
                  'text-success': (currency.totalCreditAmount - currency.totalDebitAmount) >= 0,
                  'text-warning': (currency.totalCreditAmount - currency.totalDebitAmount) < 0
                }">
                  {{ formatCurrency(currency.totalCreditAmount - currency.totalDebitAmount, currency.settlementCurrency) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
  

        <div *ngFor="let currency of transactionsData.settlementCurrencies" class="mt-5">
          <div class="currency-header p-3  text-white rounded-top d-flex justify-content-between align-items-center">
            <h4 class="mb-0">{{ 'VISA_TRANSACTIONS.SETTLEMENT_CURRENCY' | translate }}: <span class="text-primary">{{ currency.settlementCurrency }}</span></h4>
            <span class="badge bg-light text-primary fs-6">
              Total: {{ formatNumber(currency.totalTransactionCount) }} transactions
            </span>
            <span class="badge bg-light text-success fs-6">
                Credit: {{ formatNumber(currency.totalCreditTransactionCount) }} transactions
              </span>
              <span class="badge bg-light text-warning fs-6">
                Debit: {{ formatNumber(currency.totalDebitTransactionCount) }} transactions
              </span>
          </div>
  

          <div class="mb-4">
            <h5 class="mt-3 mb-2 text-visa">
              <i class="bi bi-credit-card me-2"></i>{{ 'VISA_TRANSACTIONS.BIN_SUMMARY' | translate }}
            </h5>
            <div class="table-responsive border rounded">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>BIN</th>
                    <th>Total Transactions</th>
                    <th>Credit Transactions</th>
                    <th>Debit Transactions</th>
                    <th>Total Credit</th>
                    <th>Total Debit</th>
                    <th>Avg Credit</th>
                    <th>Avg Debit</th>
                    <th>Net Amount</th>
                    <th>Pourcentage</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let bin of currency.binDetails">
                    <td class="fw-bold text-primary">{{ bin.bin }}</td>
                    <td>{{ formatNumber(bin.totalTransactionCount) }}</td>
                    <td>{{ formatNumber(bin.totalCreditTransactionCount) }}</td>
                    <td>{{ formatNumber(bin.totalDebitTransactionCount) }}</td>
                    <td class="text-success">{{ formatCurrency(bin.totalCreditAmount, currency.settlementCurrency) }}</td>
                    <td class="text-warning">{{ formatCurrency(bin.totalDebitAmount, currency.settlementCurrency) }}</td>
                    <td class="text-success">{{ formatCurrency(bin.averageCreditAmount, currency.settlementCurrency) }}</td>
                    <td class="text-warning">{{ formatCurrency(bin.averageDebitAmount, currency.settlementCurrency) }}</td>
                    <td [ngClass]="{
                      'text-success': (bin.totalCreditAmount - bin.totalDebitAmount) >= 0,
                      'text-warning': (bin.totalCreditAmount - bin.totalDebitAmount) < 0
                    }">
                      {{ formatCurrency(bin.totalCreditAmount - bin.totalDebitAmount, currency.settlementCurrency) }}
                    </td>
                    <td [ngClass]="{
                      'text-success': getBinPercentage(bin, currency) >= 0,
                      'text-danger': getBinPercentage(bin, currency) < 0
                    }">
                      {{ getBinPercentage(bin, currency) | number: '1.1-2' }}%
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>


        <div>
            <h5 class="mt-3 mb-2 text-visa">
              <i class="bi bi-briefcase me-2"></i>Business Modes
            </h5>
            
            <div *ngFor="let mode of currency.businessModes" class="business-mode-card mb-3 p-3 border rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 fw-bold text-primary">{{ mode.businessMode }}</h6>
                <button class="btn btn-sm btn-primary" 
                        (click)="viewBusinessModeDetails(currency.settlementCurrency, mode)">
                  <i class="bi bi-eye me-1"></i> {{'BUTTONS.VIEW_DETAILS' | translate}}
                </button>
              </div>
              
              <div class="row g-2">
                <div class="col-md-2">
                  <div class="p-2 bg-light rounded">
                    <small class="text-muted">Total Transactions</small>
                    <div class="fw-bold">{{ formatNumber(mode.totalTransactionCount) }}</div>
                  </div>
                </div>
                
                <div class="col-md-2">
                  <div class="p-2 bg-light rounded">
                    <small class="text-muted">Total Credit</small>
                    <div class="fw-bold text-success">{{ formatCurrency(mode.totalCreditAmount, currency.settlementCurrency) }}</div>
                  </div>
                </div>
                
                <div class="col-md-2">
                  <div class="p-2 bg-light rounded">
                    <small class="text-muted">Total Debit</small>
                    <div class="fw-bold text-warning">{{ formatCurrency(mode.totalDebitAmount, currency.settlementCurrency) }}</div>
                  </div>
                </div>
                
                <div class="col-md-2">
                  <div class="p-2 bg-light rounded">
                    <small class="text-muted">Avg Credit</small>
                    <div class="fw-bold"  
                    class="text-success">{{ formatCurrency(mode.averageCreditAmount, currency.settlementCurrency) }}
                    </div>
                  </div>
                </div>

                  
                <div class="col-md-2">
                    <div class="p-2 bg-light rounded">
                      <small class="text-muted">Avg Debit</small>
                      <div class="fw-bold" 
                      class="text-warning">{{ formatCurrency(mode.averageDebitAmount, currency.settlementCurrency) }}
                      </div>
                    </div>
               </div>
               <div class="col-md-2">
                    <div class="p-2 bg-light rounded">
                      <small class="text-muted">Net Amount</small>
                      <div class="fw-bold" [ngClass]="{
                        'text-success': (mode.totalCreditAmount - mode.totalDebitAmount) >= 0,
                        'text-warning': (mode.totalCreditAmount - mode.totalDebitAmount) < 0
                      }">
                        {{ formatCurrency(mode.totalCreditAmount - mode.totalDebitAmount, currency.settlementCurrency) }}
                      </div>
                    </div>
                </div>
            </div>
            </div>
          </div>
        </div>
      </div>
  
      <div *ngIf="transactionsData && !transactionsData.settlementCurrencies?.length" class="alert alert-info mt-4">
     {{'MESSAGES.NO_DATA_VISA' | translate}}
      </div>
    </div>
  </div>